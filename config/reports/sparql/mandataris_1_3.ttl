@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ext: <http://mu.semte.ch/vocabularies/ext/> .

<http://example.org/mandataris_1_3_shape>
a ext:SparqlShape ;
sh:targetClass <http://data.vlaanderen.be/ns/besluit#Bestuursorgaan> ;
sh:prefixes [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://data.vlaanderen.be/ns/besluit#"^^xsd:anyURI ;
        sh:prefix "besluit" ;
    ] ], [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://data.vlaanderen.be/ns/mandaat#"^^xsd:anyURI ;
        sh:prefix "mandaat" ;
    ] ], [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://www.w3.org/ns/org#"^^xsd:anyURI ;
        sh:prefix "org" ;
    ] ], [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://lblod.data.gift/vocabularies/lmb/"^^xsd:anyURI ;
        sh:prefix "lmb" ;
    ] ], [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://www.w3.org/2004/02/skos/core#"^^xsd:anyURI ;
        sh:prefix "skos" ;
    ] ], [ sh:declare [
        a sh:PrefixDeclaration ;
        sh:namespace "http://www.w3.org/2001/XMLSchema#"^^xsd:anyURI ;
        sh:prefix "xsd" ;
    ] ];
sh:sparql [
    sh:select """
      PREFIX besluit: <http://data.vlaanderen.be/ns/besluit#>
      PREFIX mandaat: <http://data.vlaanderen.be/ns/mandaat#>
      PREFIX org: <http://www.w3.org/ns/org#>
      PREFIX lmb: <http://lblod.data.gift/vocabularies/lmb/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX ext: <http://mu.semte.ch/vocabularies/ext/>

      SELECT DISTINCT $this ?value
      WHERE {
        $this a besluit:Bestuursorgaan .
        # fetch the mandaten in the orgaan with it's label and there min, max holders
        {{
          SELECT DISTINCT $this ?mandaat ?mandaatLabel ?minHouders ?maxHouders
          WHERE {
            $this org:hasPost ?mandaat.
            $this mandaat:isTijdspecialisatieVan / besluit:bestuurt ?eenheid .
            ?mandaat mandaat:aantalHouders ?maxHouders.
            ?mandaat lmb:minAantalHouders ?minHouders.
            ?mandaat org:role / skos:prefLabel ?mandaatLabel .
          }
        }}
        {{
          SELECT ?mandaat (COUNT(DISTINCT(?person)) AS ?mandatarisCount)
          WHERE {
            GRAPH ?g {
              ?mandataris a mandaat:Mandataris.
              ?mandataris org:holds ?mandaat.

              VALUES ?mandatarisStatus {
                <http://data.vlaanderen.be/id/concept/MandatarisStatusCode/e1ca6edd-55e1-4288-92a5-53f4cf71946a> # Waarnemend
                <http://data.vlaanderen.be/id/concept/MandatarisStatusCode/21063a5b-912c-4241-841c-cc7fb3c73e75> # Effectief
              }
              ?mandataris mandaat:status ?mandatarisStatus.
              ?mandataris mandaat:isBestuurlijkeAliasVan ?person.
              ?mandataris mandaat:start ?mStart.
              OPTIONAL {
                ?mandataris mandaat:einde ?mEinde.
              }
              BIND(strdt(CONCAT(substr(str(?mStart), 1, 10), "T00:00:00Z"), xsd:dateTime) AS ?safeStart)
              BIND(IF(BOUND(?mEinde), strdt(CONCAT(substr(str(?mEinde), 1, 10), "T23:59:59Z"), xsd:dateTime), "2030-12-31T23:59:59Z"^^xsd:dateTime) AS ?safeEinde)

              BIND(strdt(CONCAT(substr(str(NOW()), 1, 10), "T23:59:59Z"), xsd:dateTime) AS ?today)
              FILTER(?today <= ?safeEinde && ?today >= ?safeStart)
            }
            ?g ext:ownedBy ?eenheid . # fetch the mandaten in the orgaan with it's label and there min, max holders
          }
      }}
      FILTER(?minHouders > ?mandatarisCount || ?maxHouders < ?mandatarisCount)
      BIND(concat(str(?mandatarisCount), " mandataris(sen) voor '",str(?mandaatLabel), "' gevonden. - minimum: ", str(?minHouders), " - maximum: ", str(?maxHouders)) as ?value)
    }
    """ ;
        sh:message "Verkeerd aantal mandatarissen."
] .

